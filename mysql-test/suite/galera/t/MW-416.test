#
--source include/galera_cluster.inc

CREATE USER 'userMW416'@'localhost';
GRANT SELECT, INSERT, UPDATE ON test.* TO 'userMW416'@'localhost';

--let $wsrep_replicated_before = `SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'wsrep_replicated'`

--connect userMW416, localhost, userMW416,, test, $NODE_MYPORT_1
--connection userMW416

# DDL

--error ER_DBACCESS_DENIED_ERROR
ALTER DATABASE db CHARACTER SET = utf8;
--error ER_DBACCESS_DENIED_ERROR
ALTER EVENT ev1 RENAME TO ev2;
--error ER_PROCACCESS_DENIED_ERROR
ALTER FUNCTION fun1 COMMENT 'foo';
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR
ALTER INSTANCE ROTATE INNODB MASTER KEY;
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR
ALTER LOGFILE GROUP lfg ADD UNDOFILE 'file' ENGINE=InnoDB;
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ALTER PROCEDURE proc1 COMMENT 'foo';
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ALTER SERVER srv OPTIONS (USER 'sally');
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ALTER TABLE tbl DROP COLUMN col;
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ALTER TABLESPACE tblspc DROP DATAFILE 'file' ENGINE=innodb;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ALTER VIEW vw AS SELECT 1;

--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE DATABASE db;
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE EVENT ev1 ON SCHEDULE AT CURRENT_TIMESTAMP  DO SELECT 1;
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE FUNCTION fun1() RETURNS int RETURN(1);
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE FUNCTION fun1 RETURNS STRING SONAME 'funlib.so';
--error ER_DBACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE PROCEDURE proc1()  BEGIN END;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE INDEX idx ON tbl(id);
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE LOGFILE GROUP lfg ADD UNDOFILE 'undofile' ENGINE innodb;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE SERVER srv FOREIGN DATA WRAPPER 'fdw' OPTIONS (USER 'user');
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE TABLE t (i int);
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE TABLESPACE tblspc ADD DATAFILE 'file' ENGINE=innodb;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE TRIGGER trg BEFORE UPDATE ON t FOR EACH ROW BEGIN END;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE VIEW vw AS SELECT 1;



--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP DATABASE db;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP EVENT ev;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP FUNCTION fun1;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP INDEX idx ON t0;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP LOGFILE GROUP lfg;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP PROCEDURE proc1;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP SERVEr srv;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP TABLE t0;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP TABLESPACE tblspc;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_TRG_DOES_NOT_EXIST,ER_PROCACCESS_DENIED_ERROR
DROP TRIGGER trg;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP VIEW vw;

--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
RENAME TABLE t0 TO t1;

--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
TRUNCATE TABLE t0;

# DCL

# account management
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ALTER USER myuser IDENTIFIED BY 'pass';
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CREATE USER myuser IDENTIFIED BY 'pass';
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
DROP USER myuser;
--error ER_DBACCESS_DENIED_ERROR,ER_ACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
GRANT ALL ON *.* TO 'myuser';
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
RENAME USER myuser TO mariauser;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
REVOKE SELECT ON test FROM myuser;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR,ER_ACCESS_DENIED_NO_PASSWORD_ERROR
REVOKE ALL, GRANT OPTION FROM myuser;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR,ER_ACCESS_DENIED_NO_PASSWORD_ERROR
REVOKE PROXY ON myuser FROM myuser;

# table maintenance
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
ANALYZE TABLE db.tbl;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CHECK TABLE db.tbl;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
CHECKSUM TABLE db.tbl;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
OPTIMIZE TABLE db.tbl;
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
REPAIR TABLE db.tbl;

# plugin and user defined functions
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
INSTALL PLUGIN plg SONAME 'plg.so';
--error ER_DBACCESS_DENIED_ERROR,ER_TABLEACCESS_DENIED_ERROR,ER_SPECIFIC_ACCESS_DENIED_ERROR,ER_PROCACCESS_DENIED_ERROR
UNINSTALL PLUGIN plg;

--connection node_1
DROP USER 'userMW416'@'localhost';
SHOW DATABASES;
--let $wsrep_replicated_after = `SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'wsrep_replicated'`
--disable_query_log
--eval SELECT $wsrep_replicated_after - $wsrep_replicated_before AS wsrep_replicated_after_diff
--enable_query_log

#-------------------------------------------------------------------------------
# cover scenario involving user of CURRENT_USER()
#
--connection node_1
--echo #node-1 (create tmp user)
call mtr.add_suppression("Percona XtraDB Cluster doesn't allow use of CURRENT_USER/USER function");
#
--error ER_UNKNOWN_ERROR
CREATE USER CURRENT_USER();
#
--error ER_UNKNOWN_ERROR
DROP USER CURRENT_USER();
#
--error ER_UNKNOWN_ERROR
ALTER USER CURRENT_USER() PASSWORD EXPIRE;
--error ER_UNKNOWN_ERROR
ALTER USER CURRENT_USER() IDENTIFIED BY 'abc';
--error ER_UNKNOWN_ERROR
ALTER USER USER() IDENTIFIED BY 'abc';
#
--error ER_UNKNOWN_ERROR
RENAME USER CURRENT_USER() to 'root2'@'localhost';
--error ER_UNKNOWN_ERROR
RENAME USER 'root2'@'localhost' to CURRENT_USER();
#
--error ER_UNKNOWN_ERROR
GRANT ALL PRIVILEGES ON *.* TO CURRENT_USER();
#
--error ER_UNKNOWN_ERROR
GRANT DROP ON *.* TO CURRENT_USER();
#
--error ER_UNKNOWN_ERROR
REVOKE CREATE ON *.* FROM CURRENT_USER();
#
--error ER_UNKNOWN_ERROR
REVOKE ALL ON *.* FROM CURRENT_USER();

--connection node_2
--echo #node-2
call mtr.add_suppression("Percona XtraDB Cluster doesn't allow use of CURRENT_USER/USER function");
call mtr.add_suppression("Query apply failed.*");

#-------------------------------------------------------------------------------
# test the use of mysqladmin password change feature
# (which uses ALTER USER USER()
#
--connection node_1
--echo # node-1
CREATE USER 'mysqladmin_test' IDENTIFIED BY '1234';

# This call should fail
--echo # mysqladmin password change (should fail)
--error 1
--exec $MYSQLADMIN --user=mysqladmin_test --password=1234 -S $NODE_MYSOCK_1 -P $NODE_MYPORT_1 password 5678

# This call should succeed (with the --use-set-password option)
--echo # mysqladmin password change with --use-set-password (should succeed)
--exec $MYSQLADMIN --user=mysqladmin_test --password=1234 -S $NODE_MYSOCK_1 -P $NODE_MYPORT_1 --use-set-password password 5678

# Test our login with the new password
--connect node_1a, 127.0.0.1, mysqladmin_test, 5678,, $NODE_MYPORT_1
--connection node_1a
--echo # Login with new password successful
SELECT 1;

--connection node_1
DROP USER 'mysqladmin_test';
