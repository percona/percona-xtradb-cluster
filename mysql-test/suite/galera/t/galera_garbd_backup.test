#
# Test the sst receiver-function capability of garbd.
#

--source include/galera_cluster.inc

SHOW STATUS LIKE 'wsrep_flow_control_interval';

--connection node_1
CALL mtr.add_suppression("Protocol violation\. JOIN message sender 1\.0 \(.*\) is not in state transfer \(SYNCED\)");
CALL mtr.add_suppression("State transfer to .*");
CALL mtr.add_suppression("Process completed with error:.*");
CALL mtr.add_suppression("Command did not run:.*");
CALL mtr.add_suppression("WSREP-SST.*");
CALL mtr.add_suppression("SST start failed");
CALL mtr.add_suppression("SST failed");
CALL mtr.add_suppression("Invalid sst_request");

--connection node_2
CALL mtr.add_suppression("Protocol violation\. JOIN message sender 1\.0 \(.*\) is not in state transfer \(SYNCED\)");
CALL mtr.add_suppression("State transfer to .*");
CALL mtr.add_suppression("Process completed with error:.*");
CALL mtr.add_suppression("Command did not run:.*");
CALL mtr.add_suppression("WSREP-SST.*");
CALL mtr.add_suppression("SST start failed");
CALL mtr.add_suppression("SST failed");
CALL mtr.add_suppression("Invalid sst_request");

--exec `chmod +x "$MYSQLTEST_VARDIR/std_data/sst_garbd_test.sh"`

--exec `dirname $WSREP_PROVIDER`/../bin/garbd --sst="xtrabackup-v2:127.0.0.1:9999/xtrabackup_sst//1" --recv-script="$MYSQLTEST_VARDIR/std_data/sst_garbd_test.sh 9999" --address "gcomm://127.0.0.1:$NODE_GALERAPORT_1" --group my_wsrep_cluster --options 'evs.inactive_timeout=PT6S;base_port=$NODE_GALERAPORT_3' > $MYSQLTEST_VARDIR/tmp/garbd.log 2>&1 
SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME = 'wsrep_cluster_size';


# Error: incorrect donor sst script
--error 1
--exec `dirname $WSREP_PROVIDER`/../bin/garbd --sst="nonexistent-script:127.0.0.1:9998/xtrabackup_sst//1" --recv-script="$MYSQLTEST_VARDIR/std_data/sst_garbd_test.sh 9998" --address "gcomm://127.0.0.1:$NODE_GALERAPORT_1" --group my_wsrep_cluster --options 'evs.inactive_timeout=PT6S;base_port=$NODE_GALERAPORT_3' > $MYSQLTEST_VARDIR/tmp/garbd2.log 2>&1 
SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME = 'wsrep_cluster_size';


# Error: incorrect receiver script
--error 2
--exec `dirname $WSREP_PROVIDER`/../bin/garbd --sst="xtrabackup-v2:127.0.0.1:9999/xtrabackup_sst//1" --recv-script="nonexistent-script" --address "gcomm://127.0.0.1:$NODE_GALERAPORT_1" --group my_wsrep_cluster --options 'evs.inactive_timeout=PT6S;base_port=$NODE_GALERAPORT_3' > $MYSQLTEST_VARDIR/tmp/garbd2.log 2>&1 
SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME = 'wsrep_cluster_size';

# Simulate two connection error 
--let $command = "`dirname $WSREP_PROVIDER`/../bin/garbd"
--let $command_opt = --sst="xtrabackup-v2:127.0.0.1:9999/xtrabackup_sst//1" --donor node1 --recv-script="$MYSQLTEST_VARDIR/std_data/sst_garbd_test.sh 9999" --address "gcomm://127.0.0.1:$NODE_GALERAPORT_1" --group my_wsrep_cluster --options 'evs.inactive_timeout=PT6S;base_port=$NODE_GALERAPORT_3'
--let $output_file = $MYSQLTEST_VARDIR/tmp/garbd3.log
--let $pid_file = $MYSQLTEST_VARDIR/tmp/garbd3.pid
--source include/start_proc_in_background.inc

# Depending on how much time it passes since the previous garbd start, this either fails or succeeds.
# More than a few ms: the second garbd process knows abaut the SST transfer for the first, and waits until it is done
# Minimal time: both garbd processes think that the donor sends data to them.
# Second garbd process only notices the issue when the SST process finishes yet it didn't receive any data, and it exists with a failure.
--exec `dirname $WSREP_PROVIDER`/../bin/garbd --sst="xtrabackup-v2:127.0.0.1:9998/xtrabackup_sst//1" --donor node1 --recv-script="$MYSQLTEST_VARDIR/std_data/sst_garbd_test.sh 9998" --address "gcomm://127.0.0.1:$NODE_GALERAPORT_1" --group my_wsrep_cluster --options 'evs.inactive_timeout=PT6S;base_port=$NODE_GALERAPORT_3' > $MYSQLTEST_VARDIR/tmp/garbd4.log 2>&1  || exit 0

--connection node_1

# Wait until the background garbd process completes to avoid shutdown assertion
--source include/wait_proc_to_finish.inc

--let $wait_condition = SELECT VARIABLE_VALUE = 2 FROM performance_schema.global_status WHERE VARIABLE_NAME = 'wsrep_cluster_size'
--source include/wait_condition.inc

--remove_file $MYSQLTEST_VARDIR/tmp/garbd.log  
--remove_file $MYSQLTEST_VARDIR/tmp/garbd2.log  
--remove_file $MYSQLTEST_VARDIR/tmp/garbd3.log  
--remove_file $MYSQLTEST_VARDIR/tmp/garbd4.log  
--remove_file $MYSQLTEST_VARDIR/tmp/garbd3.pid  
