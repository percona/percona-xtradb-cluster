SET SESSION wsrep_on=OFF;
RESET MASTER;
SET SESSION wsrep_on=ON;
SET SESSION wsrep_on=OFF;
RESET MASTER;
SET SESSION wsrep_on=ON;
#=============================================
#node-1 (fire some basic ddl and dml workload on node-1)
create table t1 (i int, primary key pk(i)) engine=innodb;
insert into t1 values (1), (2), (3), (4);
select * from t1;
i
1
2
3
4
create table t2 as (select * from t1);
insert into t2 values (10), (20), (30);
select * from t2;
i
1
2
3
4
10
20
30
create table t3 like t1;
begin;
insert into t3 values (100), (200), (300);
commit;
alter table t1 add column j int;
alter table t2 add key uk(i);
drop table t1, t2;
optimize table t3;
Table	Op	Msg_type	Msg_text
test.t3	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t3	optimize	status	OK
analyze table t3;
Table	Op	Msg_type	Msg_text
test.t3	analyze	status	OK
alter table t3 add column k int;
begin;
insert into t3 values (1000, 1000), (2000, 2000);
commit;
select * from t3;
i	k
100	NULL
200	NULL
300	NULL
1000	1000
2000	2000
SHOW BINLOG EVENTS IN 'mysqld-bin.000001' FROM 125;
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000001	125	Previous_gtids	1	156	
mysqld-bin.000001	156	Anonymous_Gtid	1	233	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	233	Query	1	377	use `test`; create table t1 (i int, primary key pk(i)) engine=innodb /* xid=### */
mysqld-bin.000001	377	Anonymous_Gtid	1	456	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	456	Query	1	536	BEGIN
mysqld-bin.000001	536	Table_map	1	584	table_id: ### (test.t1)
mysqld-bin.000001	584	Write_rows	1	639	table_id: ### flags: STMT_END_F
mysqld-bin.000001	639	Xid	1	670	COMMIT /* xid=### */
mysqld-bin.000001	670	Anonymous_Gtid	1	747	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	747	Query	1	859	use `test`; CREATE TABLE `t2` (
  `i` int NOT NULL
)
mysqld-bin.000001	859	Anonymous_Gtid	1	938	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	938	Query	1	1013	BEGIN
mysqld-bin.000001	1013	Table_map	1	1061	table_id: ### (test.t2)
mysqld-bin.000001	1061	Write_rows	1	1116	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1116	Xid	1	1147	COMMIT /* xid=### */
mysqld-bin.000001	1147	Anonymous_Gtid	1	1226	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1226	Query	1	1306	BEGIN
mysqld-bin.000001	1306	Table_map	1	1354	table_id: ### (test.t2)
mysqld-bin.000001	1354	Write_rows	1	1404	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1404	Xid	1	1435	COMMIT /* xid=### */
mysqld-bin.000001	1435	Anonymous_Gtid	1	1512	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1512	Query	1	1616	use `test`; create table t3 like t1 /* xid=### */
mysqld-bin.000001	1616	Anonymous_Gtid	1	1695	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1695	Query	1	1775	BEGIN
mysqld-bin.000001	1775	Table_map	1	1823	table_id: ### (test.t3)
mysqld-bin.000001	1823	Write_rows	1	1873	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1873	Xid	1	1904	COMMIT /* xid=### */
mysqld-bin.000001	1904	Anonymous_Gtid	1	1981	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1981	Query	1	2100	use `test`; alter table t1 add column j int /* xid=### */
mysqld-bin.000001	2100	Anonymous_Gtid	1	2177	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2177	Query	1	2293	use `test`; alter table t2 add key uk(i) /* xid=### */
mysqld-bin.000001	2293	Anonymous_Gtid	1	2370	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2370	Query	1	2502	use `test`; DROP TABLE `t1`,`t2` /* generated by server */ /* xid=### */
mysqld-bin.000001	2502	Anonymous_Gtid	1	2579	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2579	Query	1	2673	use `test`; optimize table t3
mysqld-bin.000001	2673	Anonymous_Gtid	1	2750	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2750	Query	1	2836	use `test`; analyze table t3
mysqld-bin.000001	2836	Anonymous_Gtid	1	2913	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2913	Query	1	3032	use `test`; alter table t3 add column k int /* xid=### */
mysqld-bin.000001	3032	Anonymous_Gtid	1	3111	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	3111	Query	1	3191	BEGIN
mysqld-bin.000001	3191	Table_map	1	3240	table_id: ### (test.t3)
mysqld-bin.000001	3240	Write_rows	1	3293	table_id: ### flags: STMT_END_F
mysqld-bin.000001	3293	Xid	1	3324	COMMIT /* xid=### */
#=============================================
#node-2 (check for replication followed by XID)
SHOW BINLOG EVENTS IN 'mysqld-bin.000001' FROM 125;
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000001	125	Previous_gtids	2	156	
mysqld-bin.000001	156	Anonymous_Gtid	1	233	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	233	Query	1	377	use `test`; create table t1 (i int, primary key pk(i)) engine=innodb /* xid=### */
mysqld-bin.000001	377	Anonymous_Gtid	1	456	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	456	Query	1	531	BEGIN
mysqld-bin.000001	531	Table_map	1	579	table_id: ### (test.t1)
mysqld-bin.000001	579	Write_rows	1	634	table_id: ### flags: STMT_END_F
mysqld-bin.000001	634	Xid	1	665	COMMIT /* xid=### */
mysqld-bin.000001	665	Anonymous_Gtid	1	742	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	742	Query	1	854	use `test`; CREATE TABLE `t2` (
  `i` int NOT NULL
)
mysqld-bin.000001	854	Anonymous_Gtid	1	933	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	933	Query	1	1008	BEGIN
mysqld-bin.000001	1008	Table_map	1	1056	table_id: ### (test.t2)
mysqld-bin.000001	1056	Write_rows	1	1111	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1111	Xid	1	1142	COMMIT /* xid=### */
mysqld-bin.000001	1142	Anonymous_Gtid	1	1221	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1221	Query	1	1296	BEGIN
mysqld-bin.000001	1296	Table_map	1	1344	table_id: ### (test.t2)
mysqld-bin.000001	1344	Write_rows	1	1394	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1394	Xid	1	1425	COMMIT /* xid=### */
mysqld-bin.000001	1425	Anonymous_Gtid	1	1502	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1502	Query	1	1606	use `test`; create table t3 like t1 /* xid=### */
mysqld-bin.000001	1606	Anonymous_Gtid	1	1685	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1685	Query	1	1760	BEGIN
mysqld-bin.000001	1760	Table_map	1	1808	table_id: ### (test.t3)
mysqld-bin.000001	1808	Write_rows	1	1858	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1858	Xid	1	1889	COMMIT /* xid=### */
mysqld-bin.000001	1889	Anonymous_Gtid	1	1966	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1966	Query	1	2085	use `test`; alter table t1 add column j int /* xid=### */
mysqld-bin.000001	2085	Anonymous_Gtid	1	2162	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2162	Query	1	2278	use `test`; alter table t2 add key uk(i) /* xid=### */
mysqld-bin.000001	2278	Anonymous_Gtid	1	2355	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2355	Query	1	2487	use `test`; DROP TABLE `t1`,`t2` /* generated by server */ /* xid=### */
mysqld-bin.000001	2487	Anonymous_Gtid	1	2564	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2564	Query	1	2658	use `test`; optimize table t3
mysqld-bin.000001	2658	Anonymous_Gtid	1	2735	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2735	Query	1	2821	use `test`; analyze table t3
mysqld-bin.000001	2821	Anonymous_Gtid	1	2898	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2898	Query	1	3017	use `test`; alter table t3 add column k int /* xid=### */
mysqld-bin.000001	3017	Anonymous_Gtid	1	3096	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	3096	Query	1	3171	BEGIN
mysqld-bin.000001	3171	Table_map	1	3220	table_id: ### (test.t3)
mysqld-bin.000001	3220	Write_rows	1	3273	table_id: ### flags: STMT_END_F
mysqld-bin.000001	3273	Xid	1	3304	COMMIT /* xid=### */
drop table t3;
