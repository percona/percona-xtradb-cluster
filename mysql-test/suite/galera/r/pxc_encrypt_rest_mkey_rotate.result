CREATE TABLE ten (f1 INTEGER);
INSERT INTO ten VALUES (1),(2),(3),(4),(5),(6),(7),(8),(9),(10);
#node-1
CREATE TABLE t1 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) Engine=InnoDB;
INSERT INTO t1 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
CREATE TEMPORARY TABLE t2 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) Engine=InnoDB;
INSERT INTO t2 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
use test;
CREATE TABLESPACE foo ADD DATAFILE 'foo.ibd' ENCRYPTION='Y';
CREATE TABLE t3 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) tablespace foo encryption='y';
INSERT INTO t3 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
ALTER INSTANCE ROTATE INNODB MASTER KEY;
DROP TABLE t2;
#node-2
SELECT COUNT(*) = 10000 from t1;
COUNT(*) = 10000
1
SELECT COUNT(*) = 10000 from t3;
COUNT(*) = 10000
1
DROP TABLE t1;
DROP TABLE t3;
DROP TABLESPACE foo;
#node-2 being killed
Killing server ...
#node-1
CREATE TABLE t1 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) Engine=InnoDB;
INSERT INTO t1 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
CREATE TEMPORARY TABLE t2 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) Engine=InnoDB;
INSERT INTO t2 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
use test;
CREATE TABLESPACE foo ADD DATAFILE 'foo.ibd' ENCRYPTION='Y';
CREATE TABLE t3 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) tablespace foo encryption='y';
INSERT INTO t3 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
ALTER INSTANCE ROTATE INNODB MASTER KEY;
DROP TABLE t2;
#node-2 restarted
# restart
ALTER INSTANCE ROTATE INNODB MASTER KEY;
SELECT COUNT(*) = 10000 from t1;
COUNT(*) = 10000
1
SELECT COUNT(*) = 10000 from t3;
COUNT(*) = 10000
1
DROP TABLE t1;
DROP TABLE t3;
DROP TABLESPACE foo;
#node-2 being shutdown 
#node-1
CREATE TABLE t1 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) Engine=InnoDB;
INSERT INTO t1 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
CREATE TEMPORARY TABLE t2 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) Engine=InnoDB;
INSERT INTO t2 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
use test;
CREATE TABLESPACE foo ADD DATAFILE 'foo.ibd' ENCRYPTION='Y';
CREATE TABLE t3 (f1 INTEGER AUTO_INCREMENT PRIMARY KEY, f2 INTEGER) tablespace foo encryption='y';
INSERT INTO t3 (f2) SELECT a1.f1 FROM ten AS a1, ten AS a2, ten AS a3, ten AS a4;
ALTER INSTANCE ROTATE INNODB MASTER KEY;
DROP TABLE t2;
#node-2 restarted (should get encrypted table through IST)
# restart
ALTER INSTANCE ROTATE INNODB MASTER KEY;
SELECT COUNT(*) = 10000 from t1;
COUNT(*) = 10000
1
SELECT COUNT(*) = 10000 from t3;
COUNT(*) = 10000
1
DROP TABLE t1;
DROP TABLE t3;
DROP TABLESPACE foo;
